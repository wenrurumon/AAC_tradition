
library(data.table)
library(dplyr)
library(ggplot2)

x <- '46.7,13.3428571428571,9.33083333333333,22.7,22.7,7.04638883333333,44.2,30.2666666666667,11.05,30.2666666666667,25.685,0.291944082474227,8.94194444444444,9.106666625,26.7333333333333,10.1583333333333,11.35,9.08,9.08,22.7,22.7,18.12,5.7196875,22.65,30.2,9.288,6.99237176923077,45.3,15.1,23.05,18.16,18.68,22.7,1.68571428571429,9.32,9.08,6.34285714285714,4.855625,5.53704758333333,3.42467531818182,5.84523807142857,18.39,4.6151,15,22.525,15.05,2.71582180645161,8.20893936363636,12.9428571428571,8.23636363636364,10.0666666666667,23.3,5.825,4.965,2.14555555555556,5.11975311111111,15.2263333333333,11.65,9.32,5.825,7.75,6.65714285714286,9.32,1.94416129032258,10.3555555555556,7.03131103736926,6.80817403654813,6.50940170692688,6.52514687387062,6.43220503267308,5.96845902366044,5.86069034482759,11.515625,9.214,5.47646217647059,4.85243273684211,6.65004764285714,5.64075,3.41976665,5.03021426666667,5.13263888888889,8.46674245454545,3.78198355,3.26862822727273,9.0596,8.19087881818182,12.949881,6.07298486666667,6.16622226666667,10.3548148888889,18.2083334,6.559,8.15403027272727,7.4744445,18.0983334,15.1922223333333,9.1872,10.1775,10.1769047777778,30.5333333333333,12.8297618571429,11.225916625,11.225916625,17.961,14.9672221666667,17.9616666,12.6479166666667,6.41485714285714,12.8292857142857,11.22625,8.981,12.8294047142857,14.9683333333333,6.41469385714286,11.22625,2.51409342307692,22.2'
max2 <- function(x){
  if(length(x)>=7){
    sort(x)[length(x)-1]
  } else {
    max(x)
  }
}
rp <- function(x){
  apply(sapply(0:-6,function(j){
    sapply(1:length(x),function(i){max2(x[max(i+j,1):min(i+j+7,length(x))])})  
  }),1,max2)
}


###############

x <- "46.8,23.4,15.6,11.675,46.7,46.8,23.4,23.4,15.6,23.35,46.6,3.85626666666667,9.33,12.8333333333333,22.93625,46.8,31.1333333333333,46.7,46.7,46.8,46.6,46.7,31.1333333333333,15.4025,46.6,15.5,40.02,11.7,23.13916675,13.3428571428571,31.1333333333333,18.68,12.4857142857143,8.292037,14.441,15.3003333333333,13.3142857142857,23.3,46.65,15.6,13.3428571428571,46.7,46.6,22.65,22.65,22.65,45.3,23.3,23.3,32.34,31.0666666666667,23.3,18.64,9.32,46.6,46.6,15.4444443333333,18.64,13.4622223333333,1.64470588235294,15.5333333333333,20.9169092303528,20.9169092303528,19.5038850676258,19.8929866088673,19.8929866088673,20.4626403128867,20.8937500281957,23.29916675,23.13666675,13.2421428571429,23.1275,22.8975,23.175,23.2975,46.6,18.2915,11.62625,31.065,46.6,46.6,23.2975,46.6,46.6,46.6,46.05,23.02416675,46.05,23.2975,22.4975,14.998889,45,44.9,22.45,44.9,22.4525,44.9,44.9,44.9,22.1475,14.8,44.9,2.44960784615385,44.4"
avp <- as.numeric(unlist(strsplit(x,',')))
rp <- rp(avp)
p <- data.frame(week=1:length(avp),avp=avp,rp=rp) %>% melt(id='week')
ggplot() + geom_line(data=p,aes(x=week,y=value,colour=variable),size=1)
mean(avp/rp<0.9)
